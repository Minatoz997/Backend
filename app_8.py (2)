import os
import gradio as gr
import requests
import base64
from io import BytesIO
from PIL import Image
from datetime import datetime
import sqlite3
from google_auth_oauthlib.flow import Flow
from google.auth.transport.requests import Request as GoogleRequest
from fastapi import FastAPI, Request
from fastapi.responses import RedirectResponse
import json
import logging

# Setup logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Setup FastAPI app
app = FastAPI()

# Setup OAuth
CLIENT_ID = os.getenv("GOOGLE_CLIENT_ID")
CLIENT_SECRET = os.getenv("GOOGLE_CLIENT_SECRET")
REDIRECT_URI = os.getenv("GOOGLE_REDIRECT_URI", "https://backend-cb98.onrender.com/auth/callback")
SCOPES = ["profile", "email"]

if not CLIENT_ID or not CLIENT_SECRET:
    raise ValueError("GOOGLE_CLIENT_ID or GOOGLE_CLIENT_SECRET not set in environment variables.")

client_config = {
    "web": {
        "client_id": CLIENT_ID,
        "project_id": "YOUR_PROJECT_ID",
        "auth_uri": "https://accounts.google.com/o/oauth2/auth",
        "token_uri": "https://oauth2.googleapis.com/token",
        "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
        "client_secret": CLIENT_SECRET,
        "redirect_uris": [REDIRECT_URI]
    }
}

ADMIN_USERS = ["admin@kugy.ai", "testadmin"]

def init_db():
    conn = sqlite3.connect("credits.db")
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users (
                    user_id TEXT PRIMARY KEY,
                    user_name TEXT,
                    credits INTEGER,
                    login_streak INTEGER,
                    last_login TEXT,
                    last_guest_timestamp INTEGER,
                    last_reward_date TEXT
                 )''')
    conn.commit()
    conn.close()

init_db()

def check_credits(user_id, required_credits):
    if not user_id:
        return False
    if user_id in ADMIN_USERS:
        logger.info(f"Admin user {user_id}: bypassing credit check")
        return True
    conn = sqlite3.connect("credits.db")
    c = conn.cursor()
    c.execute("SELECT credits FROM users WHERE user_id = ?", (user_id,))
    result = c.fetchone()
    conn.close()
    if not result or result[0] < required_credits:
        return False
    conn = sqlite3.connect("credits.db")
    c = conn.cursor()
    c.execute("UPDATE users SET credits = credits - ? WHERE user_id = ?", (required_credits, user_id))
    conn.commit()
    conn.close()
    return True

def get_credits(user_id):
    if not user_id:
        return "0 (Invalid User)"
    if user_id in ADMIN_USERS:
        return "âˆž (Admin)"
    conn = sqlite3.connect("credits.db")
    c = conn.cursor()
    c.execute("SELECT credits FROM users WHERE user_id = ?", (user_id,))
    result = c.fetchone()
    conn.close()
    return str(result[0]) if result else "0"

def top_up_credits(user_id, user_name, amount):
    if not user_id or user_id.startswith("guest_"):
        return "Kugy.ai: Guests can't top up. Please register/login."
    if user_id in ADMIN_USERS:
        return "Kugy.ai: Admin has unlimited credits! ðŸ˜Ž"
    conn = sqlite3.connect("credits.db")
    c = conn.cursor()
    c.execute("INSERT OR IGNORE INTO users (user_id, user_name, credits, login_streak, last_login, last_guest_timestamp, last_reward_date) VALUES (?, ?, ?, ?, ?, ?, ?)",
              (user_id, user_name, 0, 0, datetime.now().strftime("%Y-%m-%d"), 0, ''))
    c.execute("UPDATE users SET credits = credits + ? WHERE user_id = ?", (amount, user_id))
    conn.commit()
    conn.close()
    return f"Kugy.ai: Added {amount} credits! Total: {get_credits(user_id)} ðŸ’°"

def check_login_streak(user_id, user_name):
    if not user_id or user_id.startswith("guest_"):
        return "Login/register for daily bonuses!"
    conn = sqlite3.connect("credits.db")
    c = conn.cursor()
    today = datetime.now().strftime("%Y-%m-%d")
    c.execute("SELECT login_streak, last_login, last_reward_date FROM users WHERE user_id = ?", (user_id,))
    result = c.fetchone()
    bonus_message = ""
    if not result:
        initial_credits = 10
        c.execute("INSERT INTO users (user_id, user_name, credits, login_streak, last_login, last_guest_timestamp, last_reward_date) VALUES (?, ?, ?, ?, ?, ?, ?)",
                  (user_id, user_name, initial_credits, 1, today, 0, today))
        conn.commit()
        bonus_message = f"Welcome, {user_name}! Got {initial_credits} free credits! ðŸ˜¸"
    else:
        streak, last_login, last_reward_date = result
        if last_reward_date == today:
            bonus_message = f"Streak: {streak} days. Daily bonus already claimed today."
        else:
            if (datetime.now() - datetime.strptime(last_login, "%Y-%m-%d")).days == 1:
                streak += 1
            else:
                streak = 1
            daily_bonus = 1
            streak_bonus = 2 if streak % 5 == 0 else 0
            total_bonus = daily_bonus + streak_bonus
            c.execute("UPDATE users SET credits = credits + ?, login_streak = ?, last_login = ?, last_reward_date = ? WHERE user_id = ?",
                      (total_bonus, streak, today, today, user_id))
            conn.commit()
            bonus_message = f"Daily login! Got {daily_bonus} credit. "
            if streak_bonus:
                bonus_message += f"Streak {streak} days! Bonus {streak_bonus} credits! ðŸŽ‰ Total: {get_credits(user_id)} ðŸ’°"
            else:
                bonus_message += f"Streak: {streak} days. Total: {get_credits(user_id)} ðŸ’°"
    conn.close()
    return bonus_message

STABILITY_API_URL = "https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image"
API_KEYS = {
    "stability": os.getenv("STABILITY_API_KEY"),
    "openrouter": os.getenv("OPENROUTER_API_KEY")
}

MAX_CACHE_SIZE = 10
image_cache = {}

def generate_image(prompt, user_id):
    if not check_credits(user_id, 3):
        return None, "Kugy.ai: Not enough credits (need 3)! Top up now~ ðŸ’°"
    cache_key = prompt.lower().strip()
    if cache_key in image_cache:
        return image_cache[cache_key], "Kugy.ai: Cached image for you! ðŸ˜˜"
    stability_key = API_KEYS["stability"]
    if not stability_key:
        logger.error("Stability API Key is missing or not set in environment!")
        return None, "Kugy.ai: Stability API Key missing! Set STABILITY_API_KEY in environment."
    headers = {"Authorization": f"Bearer {stability_key}", "Content-Type": "application/json", "Accept": "application/json"}
    payload = {"text_prompts": [{"text": prompt}], "cfg_scale": 7, "height": 512, "width": 512, "samples": 1, "steps": 30}
    try:
        logger.info(f"Calling Stability API with prompt: {prompt}")
        response = requests.post(STABILITY_API_URL, headers=headers, json=payload, timeout=30)
        logger.info(f"Stability API response status: {response.status_code}")
        if response.status_code == 200:
            resp_data = response.json()
            if "artifacts" in resp_data and resp_data["artifacts"]:
                base64_img = resp_data["artifacts"][0]["base64"]
                image = Image.open(BytesIO(base64.b64decode(base64_img))).resize((512, 512), Image.Resampling.LANCZOS)
                if len(image_cache) >= MAX_CACHE_SIZE:
                    image_cache.pop(next(iter(image_cache)))
                image_cache[cache_key] = image
                return image, "Kugy.ai: Here's your cute image! ðŸ˜º"
            return None, "Kugy.ai: Failed to get image from Stability (no artifacts)!"
        return None, f"Kugy.ai: Stability API error (status {response.status_code}): {response.text[:200]}"
    except requests.exceptions.RequestException as e:
        logger.error(f"Stability API request failed: {str(e)}")
        return None, f"Kugy.ai: Failed to connect to Stability API: {str(e)}"
    except Exception as e:
        logger.error(f"Unexpected error with Stability API: {str(e)}")
        return None, f"Kugy.ai: Unexpected error with Stability API: {str(e)}"

def chat_with_openrouter(message, history, user_id, model_select):
    if not check_credits(user_id, 1):
        return history + [("Kugy.ai: Not enough credits (need 1)! Top up! ðŸ’°", None)]
    openrouter_key = API_KEYS["openrouter"]
    if not openrouter_key:
        logger.error("OpenRouter API Key is missing or not set in environment!")
        return history + [("Kugy.ai: OpenRouter API Key missing! Set OPENROUTER_API_KEY in environment.", None)]
    
    headers = {
        "Authorization": f"Bearer {openrouter_key}",
        "Content-Type": "application/json",
        "HTTP-Referer": "http://localhost",
        "X-Title": "KugyAI"
    }
    model_map = {
        "OpenRouter (Claude 3)": "anthropic/claude-3-haiku-20240307",
        "OpenRouter (Grok 3 Mini)": "xai/grok-3-mini",
        "OpenRouter (Gemini 2.0 Flash)": "google/gemini-flash-1.5"
    }
    model_id = model_map.get(model_select, "anthropic/claude-3-haiku-20240307")
    logger.info(f"Calling OpenRouter with model: {model_id}")
    messages = [{"role": "user", "content": message}]
    payload = {"model": model_id, "messages": messages, "temperature": 0.7}
    try:
        response = requests.post("https://openrouter.ai/api/v1/chat/completions", headers=headers, json=payload, timeout=30)
        logger.info(f"OpenRouter response status: {response.status_code}")
        if response.status_code != 200:
            error_msg = response.text[:200]
            logger.error(f"OpenRouter error: {error_msg}")
            return history + [(f"Kugy.ai: OpenRouter API error (status {response.status_code}): {error_msg}", None)]
        reply = response.json()["choices"][0]["message"]["content"]
        return history + [(f"ðŸ¤– {reply}", None)]
    except requests.exceptions.RequestException as e:
        logger.error(f"OpenRouter request failed: {str(e)}")
        return history + [(f"Kugy.ai: Failed to connect to OpenRouter: {str(e)}", None)]
    except json.JSONDecodeError as e:
        logger.error(f"OpenRouter response decode error: {str(e)}")
        return history + [(f"Kugy.ai: OpenRouter response error: {str(e)}", None)]
    except Exception as e:
        logger.error(f"Unexpected error with OpenRouter: {str(e)}")
        return history + [(f"Kugy.ai: Unexpected error with OpenRouter: {str(e)}", None)]

def handle_google_callback(code, state):
    if not code or not state:
        return None, None, "Error: Missing code or state in callback.", gr.update(selected="Chat")
    if state != "xyz":
        return None, None, "Error: Invalid state parameter. Possible CSRF attack.", gr.update(selected="Welcome")
    try:
        flow = Flow.from_client_config(client_config, scopes=SCOPES, redirect_uri=REDIRECT_URI)
        flow.fetch_token(code=code)
        credentials = flow.credentials
        credentials.refresh(GoogleRequest())
        user_info = requests.get("https://www.googleapis.com/userinfo/v2/me", headers={"Authorization": f"Bearer {credentials.token}"}).json()
        user_id = user_info["email"]
        user_name = user_info.get("name", user_id.split("@")[0])
        logger.info(f"User logged in: {user_id}")
        return user_id, user_name, "Login successful! Redirecting to Chat...", gr.update(selected="Chat")
    except Exception as e:
        logger.error(f"Error in Google callback: {str(e)}")
        return None, None, f"Error during login: {str(e)}", gr.update(selected="Welcome")

@app.get('/auth/callback')
async def oauth_callback(code: str | None = None, state: str | None = None):
    gradio_base_url = "https://backend-cb98.onrender.com/"
    if code and state:
        redirect_url = f"{gradio_base_url}?code={code}&state={state}"
        return RedirectResponse(url=redirect_url)
    return RedirectResponse(url=f"{gradio_base_url}?error=missing_params")

def create_gradio_interface():
    with gr.Blocks(
        css="""
        #title { font-size: 30px; font-weight: bold; color: #4A90E2; text-align: center; }
        .credit-display { background: linear-gradient(to right, #FFD700, #FFA500); color: black; padding: 8px 12px; border-radius: 15px; text-align: center; font-weight: bold; }
        .oauth-link { display: inline-block; background-color: #4285F4; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: bold; }
        .oauth-link:hover { background-color: #3267D6; }
        """,
        theme="soft",
    ) as demo:
        gr.HTML("<div id='title'>kugy.ai â€” Your Cute Assistant ðŸ’™</div>")
        user_id_state = gr.State(value="")
        user_name_state = gr.State(value="")
        chat_state = gr.State(value={})

        with gr.Tabs() as tabs:
            with gr.Tab("Welcome", id="Welcome") as welcome_tab:
                gr.Markdown("### Welcome to Kugy.ai!")
                gr.Markdown("Login with Google to save history & get daily bonuses, or try Guest Mode (temporary history).")
                with gr.Row():
                    gr.HTML('<a href="https://accounts.google.com/o/oauth2/v2/auth?client_id=385259735074-ui76jtbrq23idr9bk86gpbmpe06691nt.apps.googleusercontent.com&redirect_uri=https://backend-cb98.onrender.com/auth/callback&response_type=code&scope=profile email&state=xyz&access_type=offline&prompt=consent" class="oauth-link">ðŸš€ Login with Google</a>')
                    guest_button = gr.Button("ðŸ‘¤ Guest Mode", variant="secondary")
                welcome_message = gr.Textbox("", label="Status", interactive=False)

                def start_guest_mode(chat_history_state):
                    guest_id = f"guest_{int(time.time())}"
                    chat_history_state[guest_id] = []
                    conn = sqlite3.connect("credits.db")
                    c = conn.cursor()
                    c.execute("INSERT OR IGNORE INTO users (user_id, user_name, credits, login_streak, last_login, last_guest_timestamp, last_reward_date) VALUES (?, ?, ?, ?, ?, ?, ?)",
                              (guest_id, "Guest", 25, 0, datetime.now().strftime("%Y-%m-%d"), int(time.time()), ''))
                    conn.commit()
                    conn.close()
                    return guest_id, chat_history_state, f"Guest Mode ({guest_id}) active! You have 25 free credits.", gr.update(selected="Chat")

                guest_button.click(
                    fn=start_guest_mode,
                    inputs=[chat_state],
                    outputs=[user_id_state, chat_state, welcome_message, tabs]
                )

                with gr.Row():
                    code_input = gr.Textbox(placeholder="Paste the 'code' from URL", label="Code")
                    state_input = gr.Textbox(placeholder="Paste the 'state' from URL (should be 'xyz')", label="State")
                    callback_btn = gr.Button("Submit Callback")

                callback_btn.click(
                    fn=handle_google_callback,
                    inputs=[code_input, state_input],
                    outputs=[user_id_state, user_name_state, welcome_message, tabs]
                )

            with gr.Tab("Chat", id="Chat") as chat_tab:
                with gr.Row():
                    credit_display = gr.Textbox("Credit: 0 ðŸ’°", interactive=False, elem_classes=["credit-display"], label="Credits")
                chatbot = gr.Chatbot(label="", height=500)
                with gr.Row():
                    model_dropdown = gr.Dropdown(
                        ["OpenRouter (Claude 3)", "OpenRouter (Grok 3 Mini)", "OpenRouter (Gemini 2.0 Flash)"],
                        value="OpenRouter (Claude 3)",
                        label="Choose AI Model"
                    )
                    textbox = gr.Textbox(placeholder="Type your message...", label="")
                    send_btn = gr.Button("Send", variant="primary")
                    clear_btn = gr.Button("Reset Chatbot", variant="secondary")
                    image_btn = gr.Button("Generate Image", variant="secondary")

                def load_chat_data(user_id, chat_history_state):
                    if not user_id:
                        return "Credit: 0 ðŸ’°", [], chat_history_state
                    credits = get_credits(user_id)
                    history = chat_history_state.get(user_id, [])
                    if not history:
                        history = [("ðŸ¤– Hi bro! How can I help?", None)]
                        chat_history_state[user_id] = history
                    return f"Credit: {credits} ðŸ’°", history, chat_history_state

                chat_tab.select(
                    fn=load_chat_data,
                    inputs=[user_id_state, chat_state],
                    outputs=[credit_display, chatbot, chat_state]
                )

                def chat(message, history, user_id, chat_history_state, model_select):
                    updated_history = chat_with_openrouter(message, history, user_id, model_select)
                    chat_history_state[user_id] = updated_history
                    return updated_history, chat_history_state

                send_btn.click(fn=chat, inputs=[textbox, chatbot, user_id_state, chat_state, model_dropdown], outputs=[chatbot, chat_state])
                textbox.submit(fn=chat, inputs=[textbox, chatbot, user_id_state, chat_state, model_dropdown], outputs=[chatbot, chat_state])

                def generate_image_action(prompt, history, user_id, chat_history_state):
                    image, message = generate_image(prompt, user_id)
                    if image:
                        history.append((message, image))
                    else:
                        history.append((message, None))
                    chat_history_state[user_id] = history
                    return history, chat_history_state

                image_btn.click(
                    fn=generate_image_action,
                    inputs=[textbox, chatbot, user_id_state, chat_state],
                    outputs=[chatbot, chat_state]
                )

                def clear_chat(user_id, chat_history_state):
                    chat_history_state[user_id] = [("ðŸ¤– Chat cleared! What's next?", None)]
                    return chat_history_state[user_id], chat_history_state

                clear_btn.click(fn=clear_chat, inputs=[user_id_state, chat_state], outputs=[chatbot, chat_state])

        def check_initial_login(user_id_state, user_name_state, chat_history_state):
            if user_id_state:
                streak_msg = check_login_streak(user_id_state, user_name_state)
                return user_id_state, user_name_state, chat_history_state, f"Welcome back! {streak_msg}", gr.update(selected="Chat")
            return "", "", chat_history_state, "Please login or select guest mode.", gr.update(selected="Welcome")

        demo.load(
            fn=check_initial_login,
            inputs=[user_id_state, user_name_state, chat_state],
            outputs=[user_id_state, user_name_state, chat_state, welcome_message, tabs]
        )

    return demo

gradio_app = create_gradio_interface()
app = gr.mount_gradio_app(app, gradio_app, path="/")

if __name__ == "__main__":
    import uvicorn
    port = int(os.getenv("PORT", 7860))
    uvicorn.run(app, host="0.0.0.0", port=port)